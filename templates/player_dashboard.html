{% extends "base.html" %}

{% block title %}OLG Game - Player Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/demandcurve.css') }}">
<style>
    /* Demand Curve Component Styles */
    .interactive-demand-curve {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .demand-curve-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .graph-section {
        flex: 1;
        min-width: 300px;
    }

    .data-section {
        flex: 1;
        min-width: 300px;
    }

    .demand-graph-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
        background-color: #fff;
    }

    .demand-graph {
        display: block;
        width: 100%;
        min-height: 400px;
    }

    .data-point-list {
        margin-bottom: 20px;
    }

    .data-point-list table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-point-list th, .data-point-list td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .data-point-list input {
        width: 70px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .borrowing-limit-info {
        margin: 15px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }

    .borrowing-limit-warning {
        color: #f44336;
        font-weight: bold;
    }

    .reset-button {
        padding: 8px 12px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        width: fit-content;
    }

    .reset-button:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" id="player-dashboard" data-user-id="{{ user_id }}">
    <!-- Header Bar -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">Round <span id="current-round">-</span></h4>
            </div>
            <div>
                <span class="badge bg-primary me-2">
                    <i class="bi bi-person-circle me-1"></i>
                    <span id="player-name">Player</span>
                </span>
                <span class="badge bg-success">
                    Stage: <span id="life-stage">-</span>
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Information Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Policy Information -->
                        <div class="col-md-6">
                            <h6>Policy Parameters</h6>
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Interest Rate:</span>
                                    <span id="interest-rate" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Tax Rate:</span>
                                    <span id="tax-rate" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between young-only">
                                    <span>Borrowing Limit:</span>
                                    <span id="borrowing-limit" class="fw-bold">-</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Current State -->
                        <div class="col-md-6">
                            <h6>Your Current State</h6>
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item d-flex justify-content-between young-only">
                                    <span>Your Net Assets:</span>
                                    <span id="current-assets" class="fw-bold">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between middle-only">
                                    <span>Your Income:</span>
                                    <span id="current-income" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between middle-only">
                                    <span>Debt from Youth:</span>
                                    <span id="debt-from-youth" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between old-only">
                                    <span>Assets from Middle Age:</span>
                                    <span id="assets-from-middle" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between old-only">
                                    <span>Pension:</span>
                                    <span id="pension" class="fw-bold">0</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Previous Round Summary -->
                    <div class="previous-round mt-3">
                        <h6>Previous Round Summary</h6>
                        <div class="card">
                            <div class="card-body">
                                <p id="previous-round-summary">No previous round data available.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decision Panel -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Decision</h5>
                </div>
                <div class="card-body">
                    <!-- Young Stage Controls -->
                    <div id="young-controls" class="decision-controls young-only" style="display: none;">
                        <h6>As a Young agent, create your borrowing demand curve</h6>
                        <p class="text-muted small">Drag points to adjust your borrowing amount at different interest rates. All points must be below the borrowing limit.</p>
                        
                        <div id="demand-curve-container" class="demand-curve-container">
                            <div class="graph-section">
                                <div class="demand-graph-container">
                                    <svg id="demand-graph" class="demand-graph"></svg>
                                </div>
                                <button id="reset-curve" class="reset-button">Reset Curve</button>
                            </div>
                            
                            <div class="data-section">
                                <div class="data-point-list">
                                    <h3>Your Borrowing Schedule</h3>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Interest Rate (%)</th>
                                                <th>Borrowing Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-points-table">
                                            <!-- Points will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="borrowing-limit-info">
                                    <p>Current borrowing limit: <span id="current-borrowing-limit">-</span></p>
                                    <p id="borrowing-limit-warning" class="borrowing-limit-warning" style="display: none;">
                                        Warning: Some of your borrowing amounts exceed the current limit.
                                        Points exceeding the limit are shown in red.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <strong>Your consumption at the current interest rate: <span id="young-consumption">0.0</span></strong>
                        </div>
                        
                        <button type="button" class="btn btn-primary mt-3" id="young-submit">Submit Decision</button>
                    </div>

                    <!-- Middle-Aged Stage Controls -->
                    <div id="middle-controls" class="decision-controls middle-only" style="display: none;">
                        <h6>As a Middle-Aged agent, you can save or borrow</h6>
                        <div class="card mb-3">
                            <div class="card-body">
                                <p>Available resources after debt repayment: <strong><span id="middle-available-resources">-</span></strong></p>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label for="middle-save-slider" class="form-label">
                                How much do you want to save? (Negative values = borrowing)
                            </label>
                            <input type="range" class="form-range" id="middle-save-slider" min="-100" max="100" step="0.1" value="0">
                            <div class="d-flex justify-content-between">
                                <span id="middle-min-save">-100</span>
                                <span id="middle-max-save">100</span>
                            </div>
                            <div class="input-group mt-2">
                                <span class="input-group-text">Amount:</span>
                                <input type="number" class="form-control" id="middle-save-input" step="0.1" value="0">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Your consumption will be: <span id="middle-consumption">0</span></strong>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" id="middle-submit">Submit Saving Decision</button>
                    </div>

                    <!-- Old Stage Controls -->
                    <div id="old-controls" class="decision-controls old-only" style="display: none;">
                        <h6>As an Old agent, you consume all your resources</h6>
                        <div class="alert alert-info mb-4">
                            <p>You will consume: <strong><span id="old-consumption">-</span></strong></p>
                            <p class="mb-0">This includes your pension and any assets you saved from middle age.</p>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-success" id="old-next-round">
                                Ready for Next Round: Rebirth as Young
                            </button>
                        </div>
                    </div>

                    <!-- Waiting Message -->
                    <div id="waiting-message" style="display: none;">
                        <div class="alert alert-warning">
                            <h6 class="mb-0">Waiting for other players to make their decisions...</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add D3 library -->
<script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>

<script>
    // Player dashboard functionality
    document.addEventListener('DOMContentLoaded', function() {
        const userId = document.getElementById('player-dashboard').dataset.userId;
        const socket = io();
        let gameState = null;
        let decisionSubmitted = false;
        let demandCurvePoints = [
            { interestRate: 0, borrowingAmount: 40 },
            { interestRate: 1, borrowingAmount: 38 },
            { interestRate: 2, borrowingAmount: 35 },
            { interestRate: 3, borrowingAmount: 30 },
            { interestRate: 5, borrowingAmount: 25 },
            { interestRate: 7, borrowingAmount: 15 },
            { interestRate: 10, borrowingAmount: 5 },
        ];
        
        // Initialize demand curve
        function initDemandCurve(borrowingLimit) {
            const width = 600;
            const height = 400;
            const margin = { top: 20, right: 30, bottom: 50, left: 50 };
            
            // Set up scales
            const xScale = d3.scaleLinear()
                .domain([0, 11])
                .range([margin.left, width - margin.right]);
                
            const yScale = d3.scaleLinear()
                .domain([0, borrowingLimit + 10])
                .range([height - margin.bottom, margin.top]);
                
            // Set up SVG
            const svg = d3.select('#demand-graph')
                .attr('width', width)
                .attr('height', height);
                
            svg.selectAll("*").remove();
            
            // Add axes with larger font size
            const xAxis = d3.axisBottom(xScale)
                .tickSize(6)
                .tickFormat(d => d + '%');
                
            const yAxis = d3.axisLeft(yScale)
                .tickSize(6);
            
            svg.append("g")
                .attr("transform", `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .selectAll("text")
                .style("font-size", "12px");
            
            svg.append("g")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(yAxis)
                .selectAll("text")
                .style("font-size", "12px");
            
            // Add labels
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 10)
                .style("text-anchor", "middle")
                .text("Interest Rate (%)");
                
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", 15)
                .style("text-anchor", "middle")
                .text("Borrowing Amount");
            
            // Draw the curve
            function updateCurve() {
                // Sort points for line drawing
                const sortedPoints = [...demandCurvePoints].sort((a, b) => a.interestRate - b.interestRate);
                
                // Draw the line connecting points
                const line = d3.line()
                    .x(d => xScale(d.interestRate))
                    .y(d => yScale(d.borrowingAmount))
                    .curve(d3.curveMonotoneX);
                    
                svg.selectAll(".demand-line").remove();
                svg.append("path")
                    .datum(sortedPoints)
                    .attr("class", "demand-line")
                    .attr("fill", "none")
                    .attr("stroke", "#2196f3")
                    .attr("stroke-width", 2)
                    .attr("d", line);
                
                // Update points
                const points = svg.selectAll(".point-group")
                    .data(demandCurvePoints);
                    
                // Remove old points
                points.exit().remove();
                
                // Create point groups for new points
                const enterGroups = points.enter()
                    .append("g")
                    .attr("class", "point-group");
                
                // Add circle to each group
                enterGroups.append("circle")
                    .attr("class", "point")
                    .attr("cx", d => xScale(d.interestRate))
                    .attr("cy", d => yScale(d.borrowingAmount))
                    .attr("r", 8)
                    .attr("fill", d => d.borrowingAmount > borrowingLimit ? "#f44336" : "#2196f3")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2);
                
                // Add background rectangle for each group
                enterGroups.append("rect")
                    .attr("class", "label-background")
                    .attr("x", d => xScale(d.interestRate) + 10 - 1)
                    .attr("y", d => yScale(d.borrowingAmount) - 14 - 2)
                    .attr("width", d => {
                        // Precisely measure text width based on number of digits
                        const digits = String(d.borrowingAmount).length;
                        return digits * 8 + 2;  // Add a slight padding
                    })
                    .attr("height", 15 + 2)
                    .attr("fill", "white")
                    .attr("rx", 2);
                
                // Add text label for each group
                enterGroups.append("text")
                    .attr("class", "point-label")
                    .attr("x", d => xScale(d.interestRate) + 10)
                    .attr("y", d => yScale(d.borrowingAmount) - 5)
                    .style("font-size", "14px")
                    .text(d => d.borrowingAmount);
                
                // Update existing point groups
                points.select("circle")
                    .attr("cx", d => xScale(d.interestRate))
                    .attr("cy", d => yScale(d.borrowingAmount))
                    .attr("fill", d => d.borrowingAmount > borrowingLimit ? "#f44336" : "#2196f3");
                
                points.select("rect.label-background")
                    .attr("x", d => xScale(d.interestRate) + 10 - 1)
                    .attr("y", d => yScale(d.borrowingAmount) - 14 - 2)
                    .attr("width", d => {
                        const digits = String(d.borrowingAmount).length;
                        return digits * 8 + 2;
                    })
                    .attr("height", 15 + 2);
                
                points.select("text.point-label")
                    .attr("x", d => xScale(d.interestRate) + 10)
                    .attr("y", d => yScale(d.borrowingAmount) - 5)
                    .text(d => d.borrowingAmount);
                
                // Add drag behavior to all point circles (both new and existing)
                svg.selectAll("circle.point")
                    .call(d3.drag()
                        .on("drag", function(event, d) {
                            if (decisionSubmitted) return;
                            
                            const newY = yScale.invert(event.y);
                            d.borrowingAmount = Math.max(0, Math.round(newY));
                            
                            // Get the parent group and update label and background
                            const pointGroup = d3.select(this.parentNode);
                            
                            // Update point position
                            d3.select(this)
                                .attr("cy", yScale(d.borrowingAmount))
                                .attr("fill", d.borrowingAmount > borrowingLimit ? "#f44336" : "#2196f3");
                            
                            // Update the background
                            pointGroup.select(".label-background")
                                .attr("y", yScale(d.borrowingAmount) - 14 - 2)
                                .attr("width", () => {
                                    // Precisely calculate width based on number of digits
                                    const digits = String(d.borrowingAmount).length;
                                    return digits * 8 + 2;  // Add a slight padding
                                });
                            
                            // Update the label
                            pointGroup.select(".point-label")
                                .attr("y", yScale(d.borrowingAmount) - 5)
                                .text(d.borrowingAmount);
                            
                            // Update the curve
                            svg.select(".demand-line")
                                .datum([...demandCurvePoints].sort((a, b) => a.interestRate - b.interestRate))
                                .attr("d", line);
                            
                            // Update the table
                            updateDataTable();
                            
                            // Update consumption preview
                            updateConsumptionPreview();
                            
                            // Check for points exceeding limit
                            checkBorrowingLimits();
                        })
                    );
            }
            
            // Initial curve draw
            updateCurve();
            
            return {
                updateCurve,
                xScale,
                yScale
            };
        }
        
        // Update the data table
        function updateDataTable() {
            const tbody = document.getElementById('data-points-table');
            tbody.innerHTML = '';
            
            demandCurvePoints.sort((a, b) => a.interestRate - b.interestRate)
                .forEach((point, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${point.interestRate}%</td>
                        <td>
                            <input type="number" 
                                min="0" 
                                value="${point.borrowingAmount}" 
                                onchange="updatePointFromTable(${index}, this.value)"
                                ${decisionSubmitted ? 'disabled' : ''}
                            />
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }
        
        // Update point from table input
        window.updatePointFromTable = function(index, value) {
            const numValue = parseInt(value, 10);
            if (!isNaN(numValue) && numValue >= 0) {
                // Update data point
                demandCurvePoints[index].borrowingAmount = numValue;
                
                // Completely remove all point groups and redraw from scratch
                d3.select('#demand-graph').selectAll(".point-group").remove();
                
                // This ensures all elements including backgrounds are properly created
                demandCurve.updateCurve();
                
                // Update consumption preview
                updateConsumptionPreview();
                
                // Check for points exceeding limit
                checkBorrowingLimits();
            }
        };
        
        // Check if any points exceed the borrowing limit
        function checkBorrowingLimits() {
            const borrowingLimit = gameState?.policy?.borrowing_limit || 40;
            const exceedingPoints = demandCurvePoints.filter(p => p.borrowingAmount > borrowingLimit);
            
            document.getElementById('borrowing-limit-warning').style.display = 
                exceedingPoints.length > 0 ? 'block' : 'none';
                
            document.getElementById('young-submit').disabled = exceedingPoints.length > 0;
        }
        
        // Update consumption preview
        function updateConsumptionPreview() {
            const interestRate = gameState?.policy?.interest_rate || 0.03;
            const borrowAmount = calculateBorrowingAtRate(demandCurvePoints, interestRate);
            document.getElementById('young-consumption').textContent = borrowAmount.toFixed(1);
        }
        
        // Calculate borrowing at specific interest rate
        function calculateBorrowingAtRate(points, interestRate) {
            if (!points || points.length === 0) return 0;
            
            // Sort points by interest rate
            const sortedPoints = [...points].sort((a, b) => a.interestRate - b.interestRate);
            
            // Try to find exact match or interpolate
            let borrowAmount = 0;
            let exactMatch = false;
            let lowerPoint = null;
            let upperPoint = null;
            
            for (let i = 0; i < sortedPoints.length; i++) {
                if (Math.abs(sortedPoints[i].interestRate - interestRate * 100) < 0.001) {
                    borrowAmount = sortedPoints[i].borrowingAmount;
                    exactMatch = true;
                    break;
                } else if (sortedPoints[i].interestRate < interestRate * 100) {
                    lowerPoint = sortedPoints[i];
                } else {
                    upperPoint = sortedPoints[i];
                    break;
                }
            }
            
            if (!exactMatch && lowerPoint && upperPoint) {
                const ratio = (interestRate * 100 - lowerPoint.interestRate) / 
                    (upperPoint.interestRate - lowerPoint.interestRate);
                borrowAmount = lowerPoint.borrowingAmount + 
                    ratio * (upperPoint.borrowingAmount - lowerPoint.borrowingAmount);
            } else if (!exactMatch && lowerPoint) {
                borrowAmount = lowerPoint.borrowingAmount;
            } else if (!exactMatch && upperPoint) {
                borrowAmount = upperPoint.borrowingAmount;
            }
            
            return borrowAmount;
        }
        
        // Initialize dashboard
        function initDashboard() {
            fetch(`/api/current_state?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    gameState = data;
                    updateInterface(data);
                })
                .catch(error => console.error('Error fetching game state:', error));
        }
        
        let demandCurve = null;
        
        // Update interface based on game state
        function updateInterface(state) {
            // Use default values if state is incomplete
            if (!state) {
                state = {
                    round: 1,
                    policy: {
                        interest_rate: 0.03,  // 3%
                        borrowing_limit: 100,
                        taxes: { young: 0, middle: 0, old: 0 }
                    },
                    user: {
                        age_stage: 'Y',
                        name: 'Player',
                        assets: 0
                    }
                };
            }
            
            // Ensure required properties exist
            if (!state.user) {
                state.user = { age_stage: 'Y', name: 'Player', assets: 0 };
            }
            
            if (!state.policy) {
                state.policy = {
                    interest_rate: 0.03,  // 3%
                    borrowing_limit: 100,
                    taxes: { young: 0, middle: 0, old: 0 }
                };
            }
            
            const user = state.user;
            const policy = state.policy;
            
            // Update header info
            document.getElementById('current-round').textContent = state.round || 1;
            document.getElementById('player-name').textContent = user.name || 'Player';
            document.getElementById('life-stage').textContent = 
                user.age_stage === 'Y' ? 'Young' : 
                user.age_stage === 'M' ? 'Middle-Aged' : 'Old';

            // Update policy info
            // Make sure interest rate is displayed correctly
            const interestRate = policy.interest_rate || 0.03; // Use default if not set
            document.getElementById('interest-rate').textContent = `${(interestRate * 100).toFixed(1)}%`;
            
            // Show the appropriate tax rate based on user's age stage
            let taxRate = 0;
            if (user.age_stage === 'Y') {
                taxRate = policy.taxes ? policy.taxes.young : 0;
            } else if (user.age_stage === 'M') {
                taxRate = policy.taxes ? policy.taxes.middle : 0;
            } else if (user.age_stage === 'O') {
                taxRate = policy.taxes ? policy.taxes.old : 0;
            }
            document.getElementById('tax-rate').textContent = `${taxRate.toFixed(1)}`;

            // Hide all stage-specific controls and show only the relevant ones
            document.querySelectorAll('.decision-controls').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.young-only').forEach(el => el.style.display = user.age_stage === 'Y' ? '' : 'none');
            document.querySelectorAll('.middle-only').forEach(el => el.style.display = user.age_stage === 'M' ? '' : 'none');
            document.querySelectorAll('.old-only').forEach(el => el.style.display = user.age_stage === 'O' ? '' : 'none');

            // Show waiting message if decisions have been submitted
            document.getElementById('waiting-message').style.display = 
                decisionSubmitted || state.waiting_for_decisions ? 'block' : 'none';

            // Update stage-specific information
            if (user.age_stage === 'Y') {
                const borrowingLimit = policy.borrowing_limit || 40;
                document.getElementById('current-borrowing-limit').textContent = borrowingLimit.toFixed(1);
                
                // Initialize or update demand curve
                if (!demandCurve) {
                    demandCurve = initDemandCurve(borrowingLimit);
                }
                
                // Update data table
                updateDataTable();
                
                // Update consumption preview
                updateConsumptionPreview();
                
                // Check borrowing limits
                checkBorrowingLimits();
                
                // Reset button handler
                document.getElementById('reset-curve').onclick = function() {
                    if (!decisionSubmitted) {
                        // Reset to default points
                        demandCurvePoints = [
                            { interestRate: 0, borrowingAmount: 40 },
                            { interestRate: 1, borrowingAmount: 38 },
                            { interestRate: 2, borrowingAmount: 35 },
                            { interestRate: 3, borrowingAmount: 30 },
                            { interestRate: 5, borrowingAmount: 25 },
                            { interestRate: 7, borrowingAmount: 15 },
                            { interestRate: 10, borrowingAmount: 5 },
                        ];
                        
                        // Get the SVG element
                        const svg = d3.select('#demand-graph');
                        
                        // Clear everything and redraw from scratch
                        svg.selectAll("*").remove();
                        
                        // Reinitialize the entire demand curve
                        demandCurve = initDemandCurve(borrowingLimit);
                        
                        // Update related elements
                        updateDataTable();
                        updateConsumptionPreview();
                        checkBorrowingLimits();
                    }
                };
                
                // Submit button handler
                document.getElementById('young-submit').onclick = function() {
                    if (!decisionSubmitted) {
                        const interestRate = state.policy.interest_rate || 0.03;
                        const borrowAmount = calculateBorrowingAtRate(demandCurvePoints, interestRate);
                        
                        submitDecision('borrow', borrowAmount, demandCurvePoints);
                    }
                };
            } 
            else if (user.age_stage === 'M') {
                document.getElementById('current-income').textContent = '60.0'; // This should come from the server
                
                // Calculate debt from youth
                const debtFromYouth = user.assets < 0 ? Math.abs(user.assets) * (1 + policy.interest_rate) : 0;
                document.getElementById('debt-from-youth').textContent = debtFromYouth.toFixed(1);
                
                // Calculate available resources
                const availableResources = 60 - debtFromYouth; // 60 is income for middle-aged
                document.getElementById('middle-available-resources').textContent = availableResources.toFixed(1);
                
                // Update slider limits
                document.getElementById('middle-save-slider').min = -availableResources;
                document.getElementById('middle-save-slider').max = availableResources;
                document.getElementById('middle-min-save').textContent = (-availableResources).toFixed(1);
                document.getElementById('middle-max-save').textContent = availableResources.toFixed(1);
                
                // Reset values if this is a new round
                if (!decisionSubmitted) {
                    document.getElementById('middle-save-slider').value = 0;
                    document.getElementById('middle-save-input').value = 0;
                    updateMiddleConsumption();
                }
            }
            else if (user.age_stage === 'O') {
                // Update Old information
                const assetsFromMiddle = user.assets > 0 ? user.assets * (1 + policy.interest_rate) : 0;
                document.getElementById('assets-from-middle').textContent = assetsFromMiddle.toFixed(1);
                document.getElementById('old-consumption').textContent = assetsFromMiddle.toFixed(1);
            }

            // Update previous round summary
            updatePreviousRoundSummary(user);
        }

        function updatePreviousRoundSummary(user) {
            const prevRoundEl = document.getElementById('previous-round-summary');
            
            if (user.previous_consumption > 0 || user.previous_utility > 0) {
                let stageText = '';
                let decisionText = '';
                
                if (user.age_stage === 'Y') {
                    stageText = 'Old';
                    decisionText = 'consumed';
                } else if (user.age_stage === 'M') {
                    stageText = 'Young';
                    decisionText = 'borrowed';
                } else {
                    stageText = 'Middle-Aged';
                    decisionText = user.previous_decision >= 0 ? 'saved' : 'borrowed';
                }
                
                prevRoundEl.innerHTML = `
                    You were <strong>${stageText}</strong>, ${decisionText} <strong>${Math.abs(user.previous_decision).toFixed(1)}</strong>, 
                    consumed <strong>${user.previous_consumption.toFixed(1)}</strong>, 
                    and earned utility of <strong>${user.previous_utility.toFixed(2)}</strong>.
                `;
            } else {
                prevRoundEl.textContent = 'No previous round data available.';
            }
        }

        // Update consumption preview for Middle-Aged
        function updateMiddleConsumption() {
            const income = 60; // This should come from the server
            const debtFromYouth = gameState?.user?.assets < 0 
                ? Math.abs(gameState.user.assets) * (1 + gameState.policy.interest_rate) 
                : 0;
            const saveAmount = parseFloat(document.getElementById('middle-save-input').value) || 0;
            
            const consumption = income - debtFromYouth + saveAmount;
            document.getElementById('middle-consumption').textContent = consumption.toFixed(1);
            
            // Validate consumption (cannot be negative)
            const submitButton = document.getElementById('middle-submit');
            if (consumption < 0) {
                document.getElementById('middle-consumption').parentElement.classList.add('text-danger');
                submitButton.disabled = true;
            } else {
                document.getElementById('middle-consumption').parentElement.classList.remove('text-danger');
                submitButton.disabled = false;
            }
        }

        // Submit decision to server
        function submitDecision(decisionType, amount, demandCurvePoints) {
            const body = {
                user_id: userId,
                decision_type: decisionType,
                amount: amount
            };
            
            // Include demand curve points if available
            if (demandCurvePoints) {
                body.demand_curve = demandCurvePoints;
            }
            
            fetch('/api/submit_decision', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    decisionSubmitted = true;
                    document.getElementById('waiting-message').style.display = 'block';
                    
                    // Disable all inputs
                    document.querySelectorAll('input, button').forEach(el => {
                        if (el.id !== 'logout-button') {
                            el.disabled = true;
                        }
                    });
                } else {
                    alert('Error submitting decision: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => console.error('Error submitting decision:', error));
        }

        // Submit decision for Middle-Aged
        document.getElementById('middle-submit')?.addEventListener('click', function() {
            const saveAmount = parseFloat(document.getElementById('middle-save-input').value) || 0;
            const decisionType = saveAmount >= 0 ? 'save' : 'borrow';
            const amount = Math.abs(saveAmount);
            submitDecision(decisionType, amount);
        });

        // Submit "ready" for Old
        document.getElementById('old-next-round')?.addEventListener('click', function() {
            // Old agents don't need to make a decision, just mark as ready
            submitDecision('consume', 0);
        });

        // Socket.io event listeners
        socket.on('connect', () => {
            console.log('Connected to server');
            initDashboard();
        });

        socket.on('round_advanced', () => {
            console.log('Round advanced');
            decisionSubmitted = false;
            
            // Reset iframe on new round
            const iframe = document.getElementById('demand-curve-iframe');
            if (iframe) {
                // Reload the iframe to reset it
                iframe.src = iframe.src;
            }
            
            initDashboard();
            
            // Re-enable all inputs
            document.querySelectorAll('input, button').forEach(el => {
                el.disabled = false;
            });
        });

        socket.on('policy_updated', (updatedState) => {
            console.log('Policy updated:', updatedState);
            // Update game state with the new data directly
            gameState = updatedState;
            // Update the interface with the new state
            updateInterface(gameState);
        });

        // Initialize dashboard on page load
        initDashboard();
    });
</script>
{% endblock %}
