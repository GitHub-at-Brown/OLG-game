{% extends "base.html" %}

{% block title %}OLG Game - Professor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-3" id="professor-dashboard">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Professor Dashboard</h4>
                    <div>
                        <span class="badge bg-primary">Round: <span id="current-round">-</span></span>
                    </div>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Equilibrium Interest Rate:
                            <i class="bi bi-question-circle text-muted" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="right"
                               title="The interest rate that clears the loan market. It balances Young borrowing + Government debt with Middle-aged saving. Negative rates may indicate secular stagnation."></i>
                        </h5>
                        <h4 id="top-equilibrium-rate" class="mb-0 badge bg-success fs-5">-</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Policy Controls -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Policy Controls</h5>
                </div>
                <div class="card-body">
                    <form id="policy-form">
                        <div class="mb-3">
                            <label for="interest-rate" class="form-label">Interest Rate</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="interest-rate" min="-0.5" max="5" step="0.01" value="0.03">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Set to -1 for market-clearing rate</div>
                        </div>
                        
                        <h6 class="mt-4">Tax Rates</h6>
                        <div class="mb-3">
                            <label for="tax-young" class="form-label">Tax on Young</label>
                            <input type="number" class="form-control" id="tax-young" min="0" step="0.1" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="tax-middle" class="form-label">Tax on Middle-Aged</label>
                            <input type="number" class="form-control" id="tax-middle" min="0" step="0.1" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="tax-old" class="form-label">Tax on Old</label>
                            <input type="number" class="form-control" id="tax-old" min="0" step="0.1" value="0">
                        </div>
                        
                        <h6 class="mt-4">Income Parameters</h6>
                        <div class="mb-3">
                            <label for="income-young" class="form-label">Young Income</label>
                            <input type="number" class="form-control" id="income-young" min="0" step="0.1" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="income-middle" class="form-label">Middle-Aged Income</label>
                            <input type="number" class="form-control" id="income-middle" min="0" step="0.1" value="60">
                        </div>
                        <div class="mb-3">
                            <label for="income-old" class="form-label">Old Income</label>
                            <input type="number" class="form-control" id="income-old" min="0" step="0.1" value="0">
                        </div>
                        
                        <h6 class="mt-4">Other Parameters</h6>
                        <div class="mb-3">
                            <label for="government-debt" class="form-label">Government Debt</label>
                            <input type="number" class="form-control" id="government-debt" min="0" step="0.1" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="borrowing-limit" class="form-label">Debt Limit</label>
                            <input type="number" class="form-control" id="borrowing-limit" min="0" step="0.1" value="100">
                        </div>
                        
                        <button type="submit" class="btn btn-primary mt-3">Update Policy</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Game Controls and Statistics -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Game Controls</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Round Control</h6>
                        <div class="d-grid gap-2">
                            <button id="advance-round" class="btn btn-success">
                                <i class="bi bi-arrow-right-circle me-2"></i>Advance to Next Round
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Game Administration</h6>
                        <div class="d-grid gap-2">
                            <button id="reset-game" class="btn btn-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>Reset Game
                            </button>
                            <small class="text-muted mt-1">Warning: This will remove all players and reset all parameters.</small>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Current Statistics</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Equilibrium Interest Rate:</span>
                                    <span id="equilibrium-rate" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Total Young Borrowing:</span>
                                    <span id="total-young-borrowing" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Total Middle-Aged Saving:</span>
                                    <span id="total-middle-saving" class="fw-bold">-</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Loan Market Balance:</span>
                                    <span id="loan-balance" class="fw-bold">-</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Waiting For Decisions</h6>
                        <div class="card">
                            <div class="card-body">
                                <div id="waiting-list">
                                    <p class="mb-0 text-muted">All decisions submitted.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users List -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Players</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Stage</th>
                                    <th>Consumption</th>
                                    <th>Assets</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body">
                                <!-- Will be populated dynamically -->
                                <tr>
                                    <td colspan="4" class="text-center">No players connected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Add Test Players</h6>
                        <div class="input-group mb-3">
                            <input type="number" class="form-control" id="test-player-count" min="1" max="50" value="3">
                            <button class="btn btn-outline-secondary" type="button" id="add-test-players">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aggregate Borrowing Demand Chart -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Aggregate Borrowing Demand</h5>
                </div>
                <div class="card-body">
                    <div id="aggregate-demand-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        let gameState = null;
        
        // Initialize tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        // Initialize dashboard by fetching current state
        function initDashboard() {
            fetch('/api/current_state')
                .then(response => response.json())
                .then(data => {
                    gameState = data;
                    updateDashboard(data);
                    renderAggregateDemandChart(data);
                })
                .catch(error => console.error('Error fetching game state:', error));
        }
        
        // Update dashboard with current game state
        function updateDashboard(state) {
            // Update round
            document.getElementById('current-round').textContent = state.round;
            
            // Update policy form values
            document.getElementById('interest-rate').value = state.policy.interest_rate;
            document.getElementById('tax-young').value = state.policy.taxes.young;
            document.getElementById('tax-middle').value = state.policy.taxes.middle;
            document.getElementById('tax-old').value = state.policy.taxes.old;
            document.getElementById('government-debt').value = state.policy.government_debt;
            document.getElementById('borrowing-limit').value = state.policy.borrowing_limit;
            
            // Update statistics
            const rateValue = (state.policy.interest_rate * 100).toFixed(2);
            document.getElementById('equilibrium-rate').textContent = `${rateValue}%`;
            
            // Update the prominent equilibrium rate display with color coding
            const topRateElement = document.getElementById('top-equilibrium-rate');
            topRateElement.textContent = `${rateValue}%`;
            
            // Color code based on rate value
            if (state.policy.interest_rate < 0) {
                // Negative rates - red
                topRateElement.className = 'mb-0 badge bg-danger fs-5';
            } else if (state.policy.interest_rate < 0.02) {
                // Low positive rates (0% to 2%) - yellow/warning
                topRateElement.className = 'mb-0 badge bg-warning text-dark fs-5';
            } else {
                // Higher positive rates (2%+) - green
                topRateElement.className = 'mb-0 badge bg-success fs-5';
            }
            
            document.getElementById('total-young-borrowing').textContent = state.aggregates.total_young_borrowing.toFixed(2);
            document.getElementById('total-middle-saving').textContent = state.aggregates.total_middle_saving.toFixed(2);
            
            const loanBalance = state.aggregates.total_middle_saving - 
                               (state.aggregates.total_young_borrowing + state.policy.government_debt);
            document.getElementById('loan-balance').textContent = loanBalance.toFixed(2);
            
            // Update waiting list
            const waitingList = document.getElementById('waiting-list');
            if (state.waiting_for && state.waiting_for.length > 0) {
                waitingList.innerHTML = '<p>Waiting for decisions from:</p>';
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';
                
                state.waiting_for.forEach(userId => {
                    const user = state.users[userId];
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${user.name} (${user.age_stage === 'Y' ? 'Young' : user.age_stage === 'M' ? 'Middle-Aged' : 'Old'})`;
                    ul.appendChild(li);
                });
                
                waitingList.appendChild(ul);
            } else {
                waitingList.innerHTML = '<p class="mb-0 text-success">All decisions submitted. Ready to advance to next round.</p>';
            }
            
            // Update players table
            const playersTableBody = document.getElementById('players-table-body');
            if (Object.keys(state.users).length > 0) {
                playersTableBody.innerHTML = '';
                
                Object.values(state.users).forEach(user => {
                    const tr = document.createElement('tr');
                    
                    const nameTd = document.createElement('td');
                    nameTd.textContent = user.name;
                    
                    const stageTd = document.createElement('td');
                    stageTd.textContent = user.age_stage === 'Y' ? 'Young' : 
                                          user.age_stage === 'M' ? 'Middle-Aged' : 'Old';
                    
                    const consumptionTd = document.createElement('td');
                    consumptionTd.textContent = user.current_consumption.toFixed(1);
                    
                    const assetsTd = document.createElement('td');
                    assetsTd.textContent = user.assets.toFixed(1);
                    
                    tr.appendChild(nameTd);
                    tr.appendChild(stageTd);
                    tr.appendChild(consumptionTd);
                    tr.appendChild(assetsTd);
                    
                    playersTableBody.appendChild(tr);
                });
            } else {
                playersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No players connected</td></tr>';
            }
        }
        
        // Render the aggregate demand chart
        function renderAggregateDemandChart(state) {
            // Clear the existing chart
            d3.select('#aggregate-demand-chart').selectAll('*').remove();
            
            // Get all young players
            const youngPlayers = Object.values(state.users).filter(user => user.age_stage === 'Y');
            
            // If no young players, display a message
            if (youngPlayers.length === 0) {
                d3.select('#aggregate-demand-chart')
                    .append('div')
                    .attr('class', 'text-center p-5 text-muted')
                    .text('No young players have submitted demand curves yet.');
                return;
            }
            
            // Standard interest rates for the x-axis (0%, 1%, 2%, etc.)
            const standardRates = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            
            // Calculate aggregate demand for each standard interest rate
            const aggregateDemand = standardRates.map(rate => {
                let totalBorrowing = 0;
                
                // Sum up borrowing from all young players at this interest rate
                youngPlayers.forEach(player => {
                    if (player.demand_curve && player.demand_curve.length > 0) {
                        // Find the closest match in the player's demand curve
                        const exactMatch = player.demand_curve.find(point => 
                            Math.abs(point.interestRate - rate) < 0.001
                        );
                        
                        if (exactMatch) {
                            totalBorrowing += exactMatch.borrowingAmount;
                        } else {
                            // Need to interpolate
                            const lowerPoint = [...player.demand_curve]
                                .sort((a, b) => a.interestRate - b.interestRate)
                                .filter(point => point.interestRate < rate)
                                .pop();
                                
                            const upperPoint = [...player.demand_curve]
                                .sort((a, b) => a.interestRate - b.interestRate)
                                .filter(point => point.interestRate > rate)
                                .shift();
                                
                            if (lowerPoint && upperPoint) {
                                // Linear interpolation
                                const ratio = (rate - lowerPoint.interestRate) / 
                                    (upperPoint.interestRate - lowerPoint.interestRate);
                                const interpolatedBorrowing = lowerPoint.borrowingAmount + 
                                    ratio * (upperPoint.borrowingAmount - lowerPoint.borrowingAmount);
                                totalBorrowing += interpolatedBorrowing;
                            } else if (lowerPoint) {
                                totalBorrowing += lowerPoint.borrowingAmount;
                            } else if (upperPoint) {
                                totalBorrowing += upperPoint.borrowingAmount;
                            }
                        }
                    }
                });
                
                return {
                    interestRate: rate,
                    borrowingAmount: totalBorrowing
                };
            });
            
            // Set up chart dimensions
            const containerWidth = document.getElementById('aggregate-demand-chart').clientWidth;
            const width = containerWidth || 800;
            const height = 400;
            const margin = { top: 30, right: 50, bottom: 50, left: 70 };
            
            // Create SVG
            const svg = d3.select('#aggregate-demand-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
                
            // Set up scales
            const xScale = d3.scaleLinear()
                .domain([0, 10])
                .range([margin.left, width - margin.right]);
                
            // Find the max borrowing amount for y-axis scale
            const maxBorrowing = d3.max(aggregateDemand, d => d.borrowingAmount) || 100;
            
            const yScale = d3.scaleLinear()
                .domain([0, maxBorrowing * 1.1]) // Add 10% padding at the top
                .range([height - margin.bottom, margin.top]);
                
            // Add axes
            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => d + '%');
                
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .selectAll('text')
                .style('font-size', '12px');
                
            const yAxis = d3.axisLeft(yScale);
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(yAxis)
                .selectAll('text')
                .style('font-size', '12px');
                
            // Add labels
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .style('text-anchor', 'middle')
                .text('Interest Rate (%)');
                
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 15)
                .style('text-anchor', 'middle')
                .text('Aggregate Borrowing Amount');
                
            // Add the line
            const line = d3.line()
                .x(d => xScale(d.interestRate))
                .y(d => yScale(d.borrowingAmount))
                .curve(d3.curveMonotoneX);
                
            svg.append('path')
                .datum(aggregateDemand)
                .attr('fill', 'none')
                .attr('stroke', '#2196f3')
                .attr('stroke-width', 3)
                .attr('d', line);
                
            // Add points
            svg.selectAll('.point')
                .data(aggregateDemand)
                .enter()
                .append('circle')
                .attr('class', 'point')
                .attr('cx', d => xScale(d.interestRate))
                .attr('cy', d => yScale(d.borrowingAmount))
                .attr('r', 5)
                .attr('fill', '#2196f3')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
                
            // Add point labels
            svg.selectAll('.point-label')
                .data(aggregateDemand)
                .enter()
                .append('text')
                .attr('class', 'point-label')
                .attr('x', d => xScale(d.interestRate))
                .attr('y', d => yScale(d.borrowingAmount) - 10)
                .attr('text-anchor', 'middle')
                .style('font-size', '11px')
                .text(d => Math.round(d.borrowingAmount));
                
            // Add a title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .text(`Aggregate Borrowing Demand (${youngPlayers.length} Young Players)`);
        }
        
        // Policy form submission
        document.getElementById('policy-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const policyData = {
                tax_young: parseFloat(document.getElementById('tax-young').value),
                tax_middle: parseFloat(document.getElementById('tax-middle').value),
                tax_old: parseFloat(document.getElementById('tax-old').value),
                government_debt: parseFloat(document.getElementById('government-debt').value),
                borrowing_limit: parseFloat(document.getElementById('borrowing-limit').value)
            };
            
            // Handle interest rate - if -1, let market clear, otherwise set it
            const interestRate = parseFloat(document.getElementById('interest-rate').value);
            if (interestRate >= -0.5) {
                policyData.interest_rate = interestRate;
            }
            
            // Send policy update to server
            fetch('/api/set_policy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(policyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Policy updated successfully');
                } else {
                    alert('Error updating policy');
                }
            })
            .catch(error => console.error('Error updating policy:', error));
        });
        
        // Advance round button
        document.getElementById('advance-round').addEventListener('click', function() {
            fetch('/api/advance_round', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Round advanced to', data.round);
                } else {
                    alert('Error advancing round');
                }
            })
            .catch(error => console.error('Error advancing round:', error));
        });
        
        // Add test players button
        document.getElementById('add-test-players').addEventListener('click', function() {
            const count = parseInt(document.getElementById('test-player-count').value);
            
            if (count > 0 && count <= 50) {
                // Show loading indicator or disable button
                const addButton = document.getElementById('add-test-players');
                const originalText = addButton.textContent;
                addButton.textContent = 'Adding...';
                addButton.disabled = true;
                
                // Call API to add test players
                fetch('/api/add_test_players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: count })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`Added ${data.count} test players`);
                        initDashboard(); // Refresh the dashboard to show new players
                    } else {
                        alert(`Error adding test players: ${data.error}`);
                    }
                    // Reset button
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error adding test players:', error);
                    alert('Failed to add test players. Check console for details.');
                    // Reset button
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                });
            } else {
                alert('Please enter a number between 1 and 50');
            }
        });
        
        // Reset game button
        document.getElementById('reset-game').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset the game? This will remove all players and reset all parameters.')) {
                fetch('/api/reset_game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Game reset successfully');
                        initDashboard(); // Refresh the dashboard to show new game state
                    } else {
                        alert('Error resetting game');
                    }
                })
                .catch(error => console.error('Error resetting game:', error));
            }
        });
        
        // Socket.io event listeners
        socket.on('connect', () => {
            console.log('Connected to server');
            initDashboard();
        });
        
        socket.on('decision_submitted', () => {
            initDashboard(); // Refresh dashboard when a player submits a decision
        });
        
        socket.on('round_advanced', () => {
            initDashboard(); // Refresh dashboard when round advances
        });
        
        socket.on('policy_updated', () => {
            initDashboard(); // Refresh dashboard when policy is updated
        });
        
        socket.on('players_added', () => {
            initDashboard(); // Refresh dashboard when test players are added
        });
        
        socket.on('player_joined', (data) => {
            console.log('New player joined:', data.player.name);
            initDashboard(); // Refresh dashboard when a new student player joins
        });
        
        socket.on('game_reset', () => {
            console.log('Game reset');
            initDashboard(); // Refresh dashboard when game is reset
        });
        
        // Initialize dashboard on page load
        initDashboard();
    });
</script>
{% endblock %}
